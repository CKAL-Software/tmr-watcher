parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"wW3P":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BUCKET_URL=exports.AWS_CLIENT_ID=exports.CREDENTIALS_KEY=void 0,exports.CREDENTIALS_KEY="credentials",exports.AWS_CLIENT_ID="6nki0f24aj9hrvluekbmkea631",exports.BUCKET_URL="https://trackmania-registry.s3.eu-west-1.amazonaws.com";
},{}],"GYWt":[function(require,module,exports) {
"use strict";var t=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.load=exports.store=exports.STORAGE_FILE=void 0;const e=t(require("fs"));function r(t,r){const o=s();o[t]=r,e.default.writeFileSync(exports.STORAGE_FILE,JSON.stringify(o))}function o(t){return s()[t]}function s(){try{return JSON.parse(e.default.readFileSync(exports.STORAGE_FILE).toString())}catch(t){return e.default.writeFileSync(exports.STORAGE_FILE,JSON.stringify({})),{}}}exports.STORAGE_FILE="tmr.json",exports.store=r,exports.load=o;
},{}],"BHXf":[function(require,module,exports) {
"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.question=exports.downloadFile=exports.msToLaptime=void 0;const t=e(require("readline")),r=e(require("node-fetch")),o=e(require("fs")),i=e(require("stream")),s=require("util"),a=require("./definitions"),n=e(require("path"));function u(e){if(void 0===e)return"";const t=Math.abs(e);if(t<1e3)return(e<0?"-":"")+`00:${Math.round(t/10).toString().padStart(2,"0")}`;const r=Math.floor(t/6e4),o=Math.floor(t%6e4/1e3),i=t%1e3;return isNaN(t)||isNaN(r)||isNaN(o)||isNaN(i)?"":(e<0?"-":"")+`${r?r+":":""}${o.toString().padStart(r>0?2:0,"0")}:${Math.floor(i/10).toString().padStart(2,"0")}`}async function d(e,t){const u=(0,s.promisify)(i.default.pipeline),d=await(0,r.default)(`${a.BUCKET_URL}/ghosts/${e}`);if(!d.ok)throw new Error(`unexpected response ${d.statusText}`);await u(d.body,o.default.createWriteStream(n.default.join(t,e.replace("<>","__"))))}function p(e){const r=t.default.createInterface({input:process.stdin,output:process.stdout});return new Promise(t=>r.question(e,e=>{r.close(),t(e)}))}exports.msToLaptime=u,exports.downloadFile=d,exports.question=p;
},{"./definitions":"wW3P"}],"AV0o":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getEmailPassword=void 0;const e=require("./util");async function s(){return{email:await(0,e.question)("CKAL email: "),password:await(0,e.question)("Password: ")}}exports.getEmailPassword=s;
},{"./util":"BHXf"}],"ooF7":[function(require,module,exports) {
"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function t(t){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?e(Object(i),!0).forEach(function(e){r(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function r(e,t,r){return(t=n(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e){var t=i(e,"string");return"symbol"==typeof t?t:String(t)}function i(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.clearCredentials=exports.isAccessTokenOld=exports.refreshCredentials=exports.getAccessToken=exports.login=void 0;const o=require("@aws-sdk/client-cognito-identity-provider"),s=require("./definitions"),c=require("./storage"),a=require("./promptLogin"),u=new o.CognitoIdentityProvider({region:"eu-west-1"});async function l(e,r){const n=await u.initiateAuth({AuthFlow:"USER_PASSWORD_AUTH",ClientId:s.AWS_CLIENT_ID,AuthParameters:{USERNAME:e.replaceAll(" ",""),PASSWORD:r}});if(!n.AuthenticationResult)throw new Error("An unexpected error occurred");(0,c.store)(s.CREDENTIALS_KEY,t(t({},n.AuthenticationResult),{},{ExpirationTimestamp:Math.round((new Date).getTime()/1e3+n.AuthenticationResult.ExpiresIn)}))}async function p(){try{let r;if(!(r=(0,c.load)(s.CREDENTIALS_KEY)))throw console.log("Missing credentials"),new Error;if(E(r))try{r=await f(r.RefreshToken),(0,c.store)(s.CREDENTIALS_KEY,r)}catch(e){throw console.log(e),new Error}return r.AccessToken+""}catch(t){const{email:e,password:r}=await(0,a.getEmailPassword)();return await l(e,r),p()}}async function f(e){const r=await u.initiateAuth({AuthFlow:"REFRESH_TOKEN",ClientId:s.AWS_CLIENT_ID,AuthParameters:{REFRESH_TOKEN:e}});if(!r.AuthenticationResult)throw new Error;return t(t({},r.AuthenticationResult),{},{RefreshToken:e,ExpirationTimestamp:Math.round((new Date).getTime()/1e3+r.AuthenticationResult.ExpiresIn)})}function E(e){return e.ExpirationTimestamp-(new Date).getTime()/1e3<300}async function w(){(0,c.store)(s.CREDENTIALS_KEY,"")}exports.login=l,exports.getAccessToken=p,exports.refreshCredentials=f,exports.isAccessTokenOld=E,exports.clearCredentials=w;
},{"./definitions":"wW3P","./storage":"GYWt","./promptLogin":"AV0o"}],"QCba":[function(require,module,exports) {
"use strict";function e(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function t(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach(function(e){o(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function o(e,t,o){return(t=n(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function n(e){var t=r(e,"string");return"symbol"==typeof t?t:String(t)}function r(e,t){if("object"!=typeof e||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var n=o.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const i=a(require("node-fetch")),l=require("./credentialsHandler"),s=require("./util"),c=a(require("form-data")),u=a(require("fs")),f=a(require("path")),d={},g="..";async function p(){const e=u.default.readdirSync(g).filter(e=>e.includes(".Replay.gbx")),t={},o=[];if(e.forEach(e=>{const[n]=e.split("."),[r,a]=n.split("__");t[r]&&t[r].time<Number(a)?o.push(e):t[r]={time:Number(a),fileName:e}}),0===o.length)console.log("Nothing to clean up");else{console.log(`${o.length} ghost${1===o.length?"":"s"} can be deleted:`),o.forEach(e=>console.log(`- ${e}`));const e=await(0,s.question)("Delete now? (Y/n): ");"y"!==e.toLowerCase()&&""!==e||o.forEach(e=>u.default.rmSync(f.default.join(g,e))),console.log(`Deleted ${o.length} ghost${1===o.length?"":"s"}`)}}async function h(){const[e,t]=await Promise.all([(0,i.default)("https://api.ckal.dk/tmr/username",{headers:{Authorization:await(0,l.getAccessToken)()}}),(0,i.default)("https://api.ckal.dk/tmr/tracks",{headers:{Authorization:await(0,l.getAccessToken)()}})]);if(!e.ok||!t.ok)return void console.log("An error occurred");const o=await t.json(),n=(await e.json()).username,r=[];o.forEach(e=>{Object.entries(e.records).filter(([e])=>e!==n).forEach(([,e])=>r.push(e.fileName.replace("<>","__").split("/")[1]))});const a=u.default.readdirSync(g).filter(e=>e.includes(".Replay.gbx")),c=r.filter(e=>!a.includes(e));if(0===c.length)return void console.log("No new ghosts");const f=await(0,s.question)(`${c.length} new ghost${1===c.length?"":"s"}. Download now? (Y/n): `);"y"!==f.toLowerCase()&&""!==f||(console.log(`Downloading new ghost${1===c.length?"":"s"}...`),await Promise.all(c.map(async e=>{d[e]=Date.now()+3e4,await(0,s.downloadFile)(e.replace("__","<>"),g),console.log(`Downloaded ghost on ${e.split("_")[1]}`)}))),p()}async function w(e){if(!e.includes(".Replay.gbx"))throw new Error(`Tried to upload ${e} but is not a ghost file`);y(u.default.readFileSync(e,"utf-8"))}async function y(e){console.log(`Attempting to upload ${e}`);const o=new c.default;o.append("file",u.default.createReadStream(e));const n=await(0,i.default)("https://api.ckal.dk/tmr/upload",{method:"POST",headers:t({Authorization:await(0,l.getAccessToken)()},o.getHeaders()),body:o});n.ok?(console.log(n.ok),console.log(`Updated ghost ${e}'`)):console.log(n.status,await n.text())}(async()=>{const{version:e}=JSON.parse(u.default.readFileSync("package.json").toString());for(console.log(`Running TrackMania Registry watcher v${e}`),await(0,l.getAccessToken)(),console.log(),console.log("Watching for file changes..."),u.default.watch(g,(e,t)=>{if(null==t||!t.includes(".Replay.gbx"))return;const o=u.default.statSync(f.default.join(g,t)).mtimeMs;t&&(!d[t]||d[t]<o)&&(d[t]=o,w(f.default.join(g,t)))});;){console.log();const e=await(0,s.question)("(E)xit, (S)ync, (C)lean up: ");"e"===e.toLowerCase()?process.exit():"s"===e.toLowerCase()?await h():"c"===e.toLowerCase()&&await p()}})();
},{"./credentialsHandler":"ooF7","./util":"BHXf"}]},{},["QCba"], null)
//# sourceMappingURL=/bundle.js.map